import{b as h,C as b,d as c,P as l,H as w,S as M,i as T,e as y,f,A as d,R as P}from"./index-25ae11b3.js";class V extends P{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}async invoke(e,t){return this._callWithConfig(r=>this.formatMessages(r),e,{...t,runType:"prompt"})}}class u extends V{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}}class _ extends h{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){const t=await this.formatMessages(e);return new b(t)}}class v extends u{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}async format(e){return new f(await this.prompt.format(e),this.role)}static fromTemplate(e,t){return new this(l.fromTemplate(e),t)}}class g extends u{static lc_name(){return"HumanMessagePromptTemplate"}async format(e){return new w(await this.prompt.format(e))}static fromTemplate(e){return new this(l.fromTemplate(e))}}class S extends u{static lc_name(){return"AIMessagePromptTemplate"}async format(e){return new d(await this.prompt.format(e))}static fromTemplate(e){return new this(l.fromTemplate(e))}}class I extends u{static lc_name(){return"SystemMessagePromptTemplate"}async format(e){return new M(await this.prompt.format(e))}static fromTemplate(e){return new this(l.fromTemplate(e))}}function j(o){return typeof o.formatMessages=="function"}function O(o){if(j(o)||T(o))return o;const e=y(o);if(e._getType()==="human")return g.fromTemplate(e.content);if(e._getType()==="ai")return S.fromTemplate(e.content);if(e._getType()==="system")return I.fromTemplate(e.content);if(f.isInstance(e))return v.fromTemplate(e.content,e.role);throw new Error(`Could not coerce message prompt template from input. Received message type: "${e._getType()}".`)}class m extends _{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.validateTemplate){const t=new Set;for(const i of this.promptMessages)if(!(i instanceof c))for(const p of i.inputVariables)t.add(p);const r=this.inputVariables,a=new Set(this.partialVariables?r.concat(Object.keys(this.partialVariables)):r),s=new Set([...a].filter(i=>!t.has(i)));if(s.size>0)throw new Error(`Input variables \`${[...s]}\` are not used in any of the prompt messages.`);const n=new Set([...t].filter(i=>!a.has(i)));if(n.size>0)throw new Error(`Input variables \`${[...n]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async _parseImagePrompts(e,t){if(typeof e.content=="string")return e;const r=await Promise.all(e.content.map(async a=>{var p;if(a.type!=="image_url"||typeof a.image_url=="string"||!((p=a.image_url)!=null&&p.url))return a;const s=a.image_url.url,i=await l.fromTemplate(s).format(t);return a.image_url.url=i,a}));return e.content=r,e}async formatMessages(e){const t=await this.mergePartialAndUserVariables(e);let r=[];for(const a of this.promptMessages)if(a instanceof c)r.push(await this._parseImagePrompts(a,t));else{const s=a.inputVariables.reduce((i,p)=>{if(!(p in t))throw new Error(`Missing value for input variable \`${p.toString()}\``);return i[p]=t[p],i},{}),n=await a.formatMessages(s);r=r.concat(n)}return r}async partial(e){const t=this.inputVariables.filter(s=>!(s in e)),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new m(a)}static fromTemplate(e){const t=l.fromTemplate(e),r=new g({prompt:t});return this.fromMessages([r])}static fromMessages(e){const t=e.reduce((s,n)=>s.concat(n instanceof m?n.promptMessages:[O(n)]),[]),r=e.reduce((s,n)=>n instanceof m?Object.assign(s,n.partialVariables):s,Object.create(null)),a=new Set;for(const s of t)if(!(s instanceof c))for(const n of s.inputVariables)n in r||a.add(n);return new m({inputVariables:[...a],promptMessages:t,partialVariables:r})}static fromPromptMessages(e){return this.fromMessages(e)}}export{_ as B,m as C,g as H,I as S};
